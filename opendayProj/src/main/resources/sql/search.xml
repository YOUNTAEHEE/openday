<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.search">

	<select id="searchSelect"
		resultType="com.kosta.openday.user.dto.CollectDTO"
		parameterType="java.util.Map">
		<choose>



			<when
				test="scdLoc=='all' and startDate==null and clsCode=='all'">
				<![CDATA[
	SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 

				]]>
			</when>
			<when test="scdLoc=='all' and startDate==null">
				<![CDATA[
				SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 
				WHERE o.clsCode=#{clsCode}
				]]>
			</when>
			<when test="scdLoc=='all' and clsCode=='all'">
				<![CDATA[
			SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 
				WHERE  s.scdDate between #{startDate} and #{endDate}
				]]>
			</when>
			<when test="startDate==null and clsCode=='all'">
				<![CDATA[
				SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 
				WHERE s.clsLoc=#{clsLoc} 
				]]>
			</when>
			<when test="scdLoc=='all'">
				<![CDATA[
				SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 
				WHERE (s.scdDate between #{startDate} and #{endDate}) and o.clsCode=#{clsCode}
				]]>
			</when>
			<when test="startDate==null">
				<![CDATA[
				SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 
				WHERE s.clsLoc=#{clsLoc} and o.clsCode=#{clsCode}
				]]>
			</when>
			<when test="clsCode=='all'">
				<![CDATA[
				SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 
				WHERE s.clsLoc=#{clsLoc} and (s.scdDate between #{startDate} and #{endDate})
				]]>
			</when>
			<otherwise>
				<![CDATA[
				SELECT o.clsId As clsId , o.clsLoc AS clsLoc, o.clsPrice AS clsPrice, o.clsDiscount AS clsDiscount, o.clsName AS clsName, c.codName AS codName, 
               o.filNum AS filNum, 
               IFNULL((SELECT COUNT(r.rvStar)
            FROM oclass o
            JOIN schedule s ON o.clsId = s.clsId
            JOIN review r ON s.scdNum = r.scdNum 
            GROUP BY o.clsId HAVING o.clsId = 3),0) AS reviewCount,
                     (o.clsPrice - (o.clsPrice * (o.clsDiscount / 100))) AS finalPrice,
                     IFNULL((SELECT AVG(r.rvStar)
                     FROM review r JOIN schedule s
                     WHERE r.scdNum = s.scdNum
                     ),0)AS avgStar , IFNULL((
                     select COUNT(*)
                     from heart h
                     WHERE h.clsId = o.clsId
                     ),0) AS heartCnt
            FROM oclass o JOIN code c ON o.clsCode=c.codNum 
				WHERE s.clsLoc=#{clsLoc} and (s.scdDate between #{startDate} and #{endDate}) and o.clsCode=#{clsCode}
				]]>
			</otherwise>
		</choose>
	</select>

</mapper>